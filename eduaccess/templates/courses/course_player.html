{% extends "base_student.html" %}
{% load static %}

{% block title %}{{ active_module.title }}{% endblock %}

{% block extra_head %}
<style>
    .active-module-gradient {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    }
    .custom-scrollbar::-webkit-scrollbar { width: 5px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(30, 64, 175, 0.2); border-radius: 10px; }
    .rich-content { font-family: 'Inter', system-ui, sans-serif; }
    .rich-content h2 { font-size: 1.875rem; font-weight: 800; color: #111827; margin-top: 3.5rem; margin-bottom: 1.25rem; }
    .rich-content p { font-size: 1.125rem; line-height: 1.8; color: #4b5563; margin-bottom: 1.5rem; }
    .video-container-pro { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 1.5rem; margin: 4rem 0; shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.2); }
    .video-container-pro iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
    .btn-audio-ia { transition: all 0.3s ease; }
    .btn-audio-ia:hover { transform: scale(1.1); }
</style>
{% endblock %}

{% block content %}
<div class="flex h-screen overflow-hidden bg-white dark:bg-gray-950">

    <aside class="w-64 flex-shrink-0 bg-blue-700 dark:bg-slate-900 border-r border-blue-800 flex flex-col h-full z-20 hidden md:flex">
        <div class="p-6 flex-1 overflow-y-auto custom-scrollbar">
            <nav class="space-y-2 mt-4">
                {% for module in modules %}
                <a href="{% url 'course_module_detail' offering.id module.id %}"
                   class="flex items-start px-4 py-3 rounded-xl text-xs font-bold transition-all
                   {% if module.id == active_module.id %}
                   active-module-gradient text-white shadow-lg
                   {% else %}
                   text-blue-100 hover:bg-blue-600/50
                   {% endif %}">
                    <span class="flex-shrink-0 w-5 h-5 flex items-center justify-center rounded bg-black/20 mr-3 text-[9px]">
                        {{ module.order }}
                    </span>
                    <span class="leading-tight">{{ module.title }}</span>
                </a>
                {% endfor %}
            </nav>
        </div>
    </aside>

    <main class="flex-1 h-full overflow-y-auto bg-white dark:bg-gray-950">
        <header class="max-w-4xl mx-auto pt-20 px-10">
            <h1 class="text-4xl md:text-5xl font-black text-gray-900 dark:text-white mb-8 tracking-tight">
                {{ active_module.title }}
            </h1>
            {% if active_module.description %}
            <p class="text-xl text-gray-500 border-l-4 border-blue-600 pl-8">
                {{ active_module.description }}
            </p>
            {% endif %}
            <hr class="mt-10 border-gray-100">
        </header>

        <article class="max-w-4xl mx-auto py-12 px-10 pb-48 rich-content">
            {% for item in contents %}
                <div class="mb-16 last:mb-0">

                    {# 1. TEXTO #}
                    {% if item.content_type == 'text' %}
                        <div class="prose prose-blue lg:prose-xl dark:prose-invert max-w-none">
                            {{ item.text_content|safe|linebreaks }}
                        </div>

                    {# 2. VIDEO #}
                    {% elif item.content_type == 'video' %}
                        <div class="video-container-pro">
                            <iframe src="{{ item.video_url }}" allowfullscreen></iframe>
                        </div>

                    {# 3. IMAGEN #}
                    {% elif item.content_type == 'image' %}
                        {% if item.file_upload %}
                        <figure class="my-16">
                            <div class="relative rounded-3xl overflow-hidden shadow-2xl border border-gray-100">
                                <img src="{{ item.file_upload.url }}" alt="{{ item.title }}" class="w-full">
                                {% if item.ai_accessibility_text %}
                                <button onclick="leerTexto('{{ item.ai_accessibility_text|escapejs }}')"
                                        class="btn-audio-ia absolute bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-2xl hover:bg-blue-700 flex items-center justify-center">
                                    <span class="material-icons">volume_up</span>
                                </button>
                                {% endif %}
                            </div>
                            {% if item.ai_accessibility_text %}
                                <div class="mt-6 p-6 bg-blue-50 dark:bg-blue-900/10 rounded-2xl border border-blue-100">
                                    <p class="text-sm text-blue-800 dark:text-blue-300 italic">
                                        <span class="font-black uppercase text-[10px] block mb-1">Descripción de IA</span>
                                        {{ item.ai_accessibility_text }}
                                    </p>
                                </div>
                            {% endif %}
                        </figure>
                        {% endif %}

                    {# 4. ARCHIVO/PDF #}
                    {% elif item.content_type == 'file' %}
                        {% if item.file_upload %}
                        <div class="bg-gray-50 dark:bg-slate-900 rounded-[2rem] p-8 border-2 border-dashed border-gray-200">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center space-x-4">
                                    <span class="material-icons text-4xl text-blue-600">description</span>
                                    <h3 class="text-xl font-bold">{{ item.title }}</h3>
                                </div>
                                <a href="{{ item.file_upload.url }}" class="bg-blue-600 text-white px-8 py-3 rounded-2xl font-bold shadow-lg">Descargar</a>
                            </div>
                            {% if item.ai_accessibility_text %}
                                <div class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-sm border border-gray-100">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-[10px] font-black text-blue-600 uppercase tracking-widest">Texto procesado por IA</span>
                                        <button onclick="leerTexto('{{ item.ai_accessibility_text|escapejs }}')" class="text-blue-600 text-sm font-bold flex items-center">
                                            <span class="material-icons text-sm mr-1">play_circle</span> Escuchar
                                        </button>
                                    </div>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed italic">{{ item.ai_accessibility_text|linebreaks }}</p>
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}

                    {# 5. EVALUACIÓN #}
                    {% elif item.content_type == 'assessment' %}
                        <div class="my-20 p-12 bg-gray-900 rounded-[2.5rem] text-center shadow-2xl">
                            <h3 class="text-3xl font-black text-white mb-4">{{ item.title }}</h3>
                            <p class="text-gray-400 mb-8 max-w-md mx-auto">Completa el desafío final de esta lección.</p>
                            <a href="#" class="inline-block px-12 py-4 bg-blue-600 text-white rounded-2xl font-black">INICIAR →</a>
                        </div>
                    {% endif %}

                </div>
            {% endfor %}

            <footer class="mt-20 pt-16 border-t-2 border-gray-50 flex justify-center">
                <form method="POST" action="{% url 'complete_module' offering.id active_module.id %}">
                    {% csrf_token %}
                    <button class="px-20 py-5 bg-blue-600 text-white rounded-2xl font-black text-xl shadow-xl hover:bg-blue-700">
                        {% if progress.completed %} ✓ COMPLETADA {% else %} FINALIZAR {% endif %}
                    </button>
                </form>
            </footer>
        </article>
    </main>
</div>

<script>
    function leerTexto(texto) {
        if (!texto) return;
        window.speechSynthesis.cancel();
        const mensaje = new SpeechSynthesisUtterance(texto);
        mensaje.lang = 'es-EC';
        mensaje.rate = 0.95;
        window.speechSynthesis.speak(mensaje);
    }
</script>
{% endblock %}